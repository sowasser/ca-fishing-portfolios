---
title: "Annual trends in California fisheries from 1992-2014"
author: "Sophia Wassermann"
date: "3/1/2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Data source

These data were downloaded from the [California Department of Natural Resources, Characterization of Human Uses and the Socioenonomic Dimensions, California North Coast MPA Baseline Study, 1992 to 2014][1].


## Overall timeseries
Aggregated across all ports, the timeseries for the number of fishers, total revenue, and pounds landed from 1992-2014 shows a general declining trend in fishers and pounds landed. Revenue is highly variable over the timeseries, with a large increase in 2012 and 2014.

```{r, include=FALSE}
# Code for a summary of the timeseries data for all of CA, pulled from all_ca_summary.R
library(reshape2)
library(ggplot2)

ca_summary <- read.csv("Data/ca_summary_92-14.csv")

# Overall trends across timeseries --------------------------------------------
summary_long <- melt(ca_summary, id="year")  # convert to long form for faceted graph
summary_long$year <- as.numeric(summary_long$year)

# Create list to use as year labels in graph
years <- c("92", "93", "94", "95", "96", "97", "98", "99", "00", "01", "02", 
           "03", "04", "05", "06", "07", "08", "09", "10", "11", "12", "13", "14")

summary_plot <- ggplot(summary_long, aes(x = year, y = value)) + 
  theme_bw() +
  geom_line(size = 1) +  
  ylab(" ") + 
  scale_x_continuous(labels=years, breaks=ca_summary$year) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  facet_wrap(~variable, scale="free", ncol = 1)
```

```{r summary_plot, fig.width = 4.5, fig.height = 5.5, fig.align = "center", echo=FALSE}
summary_plot
```

## Timeseries by port
There is high variability in the amount of revenue collected for each port in the dataset, with the same increase towards the end of the timeseries (as seen in the general data above) for a few ports, namely the Bodega Bay Area Ports, Monterey Area Ports, the Princeton-Half Moon Area Ports, and the Ventura ports.

```{r, include=FALSE}
# Code for total revenue per port graph, from CA_port_landings.R
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)

# Read in all landings data
port_landings <- read.csv("Data/port_landings_updated.csv")

pl <- port_landings %>% drop_na()  # remove NAs
pl <- pl[order(pl$year, pl$port, -pl$ex.vessel_revenue), ]  # order by revenue

# Total revenue per port per year
pl_revenue <- group_by(pl, year, port) %>% summarize(revenue = sum(ex.vessel_revenue))
pl_revenue <- pl_revenue %>% filter(port != "OTHER CA PORTS")  # remove empty port category

total_revenue <- ggplot(pl_revenue, aes(x = year, y = revenue)) + 
  theme_bw() +
  geom_line(size=1) +  
  ylab("overall revenue") + xlab(" ") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  facet_wrap(~port, ncol = 5)
```

```{r total_revenue, fig.width = 12, fig.height = 12, fig.align = "center", echo=FALSE}
total_revenue
```

\newpage

The number of fisheries engaged in by port shows a much more consistent, downward trend, or a relatively flat trend. Each fishery here is defined as a species and gear combination.

```{r, include=FALSE}
# Code for numer of fisheries per port graph, from CA_port_landings.R
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)

# Read in all landings data
port_landings <- read.csv("Data/port_landings_updated.csv")

pl_fishgear <- pl %>% unite(fishgear, fishery, gear, sep = " - ")
pl_fishgear$fishgear <- as.factor(pl_fishgear$fishgear)
pl_fishgear <- pl_fishgear %>% filter(port != "OTHER CA PORTS")

pl_count <- count(pl_fishgear, year, port)

fisheries_number <- ggplot(pl_count, aes(x = year, y = n)) + 
  theme_bw() +
  geom_line(size=1) +  
  ylab("number of fisheries") + xlab(" ") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  facet_wrap(~port, ncol = 5)
```


```{r fisheries_number, fig.width = 12, fig.height = 12, fig.align = "center", echo=FALSE}
fisheries_number
```

\newpage

## Timeseries by fishery species
The timeseries of revenue for each species (here all gear types combined) demonstrate both what are the most revenue-producing species (dungeness crab, lobster, squid, red urchin, salmon) and the general trends in each species from 1992-2014. Notably, there has not been a significant fishery for species such as herring roe since the late 1990s, along with a large decline in red urchin around the same period. Market squid, on the other hand, has increased over the timeseries, as has dungeness crab, though revenue is highly variable. 

```{r, include=FALSE}
# Code for plot of revenue by fisheries species, from species_revenue.R
library(dplyr)
library(reshape2)
library(ggplot2)

port_landings <- read.csv("Data/port_landings_updated.csv")

fish_sums <- group_by(port_landings, year, port, fishery) %>% 
  summarize(revenue = sum(ex.vessel_revenue))
fish_sums <- fish_sums %>% drop_na()
fish_sums2 <-  group_by(fish_sums, year, fishery) %>% 
  summarize(revenue = sum(revenue))

fish_revenue_sum <- ggplot(fish_sums2, aes(x = year, y = revenue)) +
  theme_bw() +
  geom_line(size=1) +  
  ylab("revenue") + xlab(" ") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  facet_wrap(~fishery, ncol = 6)
```

```{r fish_revenue_sum, fig.width = 12, fig.height = 10, fig.align = "center", echo=FALSE}
fish_revenue_sum
```

\newpage

Overall, for each year, the most valuable fishery was most often market squid (12 years), followed by dungeness crab (8 years), herring roe (2 years), and shrimp/prawn (1 year).

``` {r, include=FALSE}
# Code for overall most revenue-producing species per year, from CA_port_landings.R
library(dplyr)
library(tidyr)
library(reshape2)
library(ggplot2)

# Read in all landings data
port_landings <- read.csv("Data/port_landings_updated.csv")

pl_max_yr <- pl %>% 
  arrange(year, desc(ex.vessel_revenue)) %>% 
  group_by(year) %>%
  slice(1:1)

max_revenue_yr <- ggplot(pl_max_yr, aes(y = ex.vessel_revenue, x = year, fill = fishery)) +
  geom_bar(position = "dodge", stat = "identity") +
  ylab("revenue") +
  theme_bw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```

```{r max_revenue_yr, fig.width = 6, fig.height = 3.5, fig.align = "center", echo=FALSE}
max_revenue_yr
```


## Fisheries timings and co-occurrence
Diverse fisheries portfolios can be complimentary (composed of species fished at opposing times of the year) or substitutional (fished at similar times of the year). To begin to explore how fishers in California build their portfolios, below is a Gantt chart of the open seasons (or peak times) for the most valuable fisheries. The data were gathered largely from the [California Sea Grant Seafood Profiles][2], with additional data for coastal pelagics from the [CA Department of Fish and Wildlife 2019 California Coastal Pelagic Species Fishery dataset][3].

```{r, include=FALSE}
# Code for Gantt chart of fisheries timings, from fishery_timings.R
library(plyr)
library(tidyverse)
library(lubridate)
library(scales)

port_landings <- read.csv("Data/port_landings_updated.csv")


# Add season timings to the dataset -------------------------------------------
# Remove "smeltlike fish", where no season data are available
port_landings <- port_landings %>% filter(fishery != "SMELTLIKE FISH")

species <- levels(factor(port_landings$fishery))  # list of species
print(species)

opens <- c("July", "June 16", "January", "Year-round", "November 15", 
           "Year-round", "December", "Year-round", "early October", 
           "September", "Year-round", "June", "Year-round", "Year-round", 
           "Year-round", "Year-round", "Year-round", "May 1", "Year-round", 
           "Year-round", "Year-round", "Year-round", "late February", 
           "August 1", "Year-round", "Year-round", "July 1", "June")

closes <- c("August", "March 14", "October", "Year-round", "July 15", 
            "Year-round", "March", "Year-round", "mid-March", "March",
            "Year-round", "November", "Year-round", "Year-round", "Year-round",
            "Year-round", "Year-round", "October 31", "Year-round", 
            "Year-round", "Year-round", "Year-round", "September", "April 30",
            "Year-round", "Year-round", "March 22", "March")

# Number of days after Nov 15 - start of a new year for this project
# Calculations done here: https://www.timeanddate.com/date/duration.html?y1=2020&m1=11&d1=15&y2=2021&m2=3&d2=1
opens_count <- c(228, 213, 47, 1, 1, 1, 16, 1, 320, 290, 1, 198, 1, 1, 1, 1, 1,
                 167, 1, 1, 1, 1, 105, 259, 1, 1, 228, 198)

closes_count <- c(259, 119, 320, 364, 242, 364, 106, 364, 120, 106, 364, 351, 
                  364, 364, 364, 364, 364, 350, 364, 364, 364, 364, 290, 166,
                  364, 364, 127, 106)

# Combine into one dataframe to double check timings
seasons <- as.data.frame(cbind(species, opens, closes, opens_count, closes_count))

# Isolate the list of fisheries from all of the data to be replaced with the
# start and end dates (saved as new lists). 
fishery <- port_landings$fishery

start_day <- mapvalues(fishery, from = species, to = opens_count)
end_day <- mapvalues(fishery, from = species, to = closes_count)
# TODO: mapvalues is from plyr & a method from dplyr or elsewhere would be better

# Combine with original port landings data & export as .csv
pl_timings <- cbind(port_landings, start_day, end_day)
write.csv(pl_timings, file = "Data/port_landings_timings.csv", row.names = FALSE)

# Gantt chart for species of interest -----------------------------------------
tasks <- tribble(
  ~Start,       ~End,         ~Project,          ~Task,
  "2020-07-01", "2020-08-31", "Seasonal", "Albacore tuna",
  "2020-06-16", "2020-03-14", "Seasonal", "California halibut",
  "2020-01-01", "2020-10-31", "Seasonal", "Coastal pelagics",
  "2019-12-01", "2020-07-15", "Seasonal", "Dungeness Crab",
  "2019-10-01", "2020-03-15", "Seasonal", "Lobster",
  "2019-09-01", "2020-03-30", "Seasonal", "Market squid",
  "2019-11-15", "2020-11-14", "Year-round", "Red urchin",
  "2019-11-15", "2020-11-14", "Year-round", "Sablefish",
  "2020-05-01", "2020-10-31", "Seasonal", "Salmon",
  "2019-11-15", "2020-11-14", "Year-round", "Shelf-slope rockfish",
  "2020-02-20", "2020-09-01", "Seasonal", "Spot prawn",
  "2019-11-15", "2020-11-14", "Year-round", "Swordfish",
  "2019-11-15", "2020-11-14", "Year-round", "Thornyhead",
)

# Convert data too long for ggplot
tasks.long <- tasks %>%
  mutate(Start = ymd(Start),
         End = ymd(End)) %>%
  gather(date.type, task.date, -c(Project, Task)) %>%
  arrange(date.type, task.date) %>%
  mutate(Task = factor(Task, levels=rev(unique(Task)), ordered=TRUE))

# Custom theme for making a clean Gantt chart
theme_gantt <- function(base_size=11) {
  ret <- theme_bw()
  theme(panel.background = element_rect(fill="#ffffff", colour=NA),
        axis.title.x=element_text(vjust=-0.2), 
        axis.title.y=element_text(vjust=1.5),
        title=element_text(vjust=1.2),
        panel.border = element_rect(colour = "black", fill=NA, size=1),
        axis.line=element_blank(),
        axis.ticks=element_blank(),
        legend.position="bottom", 
        axis.title=element_text(size=rel(0.8)),
        strip.text=element_text(size=rel(1)),
        strip.background=element_rect(fill="#ffffff", colour=NA),
        panel.spacing.y=unit(1.5, "lines"),
        legend.key = element_blank())
  
  ret
}

# Build plot
timeline <- ggplot(tasks.long, aes(x=Task, y=task.date, colour=Project)) + 
  geom_line(size=6) + 
  guides(colour=guide_legend(title=NULL)) +
  labs(x=NULL, y=NULL) + coord_flip() +
  scale_y_date(date_breaks="1 month", labels=date_format("%b")) +  # Change how the dates on x-axis display
  theme_gantt() + theme(axis.text.x=element_text(angle=45, hjust=1)) 
timeline
```

```{r timeline, fig.width = 9, fig.height = 3.5, fig.align = "center", echo=FALSE}
timeline
```

\newpage

To determine which species are often fished together, a fisheries species co-occurrence matrix was produced using ```cooccur```

```{r, include=FALSE}
# Code for the fisheries co-occurrence matrix, from port_cluster.R

detach(package:plyr, unload=TRUE) # unload plyr so dplyr will work
library(dplyr)
library(cluster)
library(factoextra)
library(ggplot2)
library(reshape2)
library(cooccur)

port_landings <- read.csv("Data/port_landings_updated.csv")
                          
# Subset original port_landings dataframe
pl_occurrence <- subset.data.frame(port_landings, 
                                   select = c("year", "port", "fishery", 
                                              "ex.vessel_revenue"))
# Combine multiple gear types together
pl_occurrence <- group_by(pl_occurrence, year, port, fishery) %>%
  summarize(revenue = sum(ex.vessel_revenue))

# Limit to fisheries of interest (higher revenue)
target_species <- c("CALIFORNIA HALIBUT", "LOBSTER", "MARKET SQUID", 
                    "DUNGENESS CRAB", "ALBACORE TUNA", "SPOT PRAWN", 
                    "COASTAL PELAGICS", "SALMON", "RED URCHIN", "SABLEFISH",
                    "SHELF-SLOPE ROCKFISH", "SWORDFISH", "THORNYHEAD")
pl_occur_subset <- filter(pl_occurrence, fishery %in% target_species)

# Co-occurrence for all years together
occur <- dcast(pl_occur_subset, fishery ~ port)  # re-arrange to wide format
occur <- occur %>% mutate_if(is.numeric, ~1 * (. > 0))  # replace all values > 0 with 1
row.names(occur) <- occur[, 1]  # make species name (1st column) the row names
occur <- occur[, -1]  # remove species name column

co <- cooccur(occur, spp_names = TRUE)  # run co-occurrence 
co_results <- prob.table(co)  # islole results 

occur_matrix <- plot(co)  # create a species co-occurrence matrix plot
```

```{r occur_matrix, fig.width = 7, fig.height = 7, fig.align = "center", echo=FALSE}
occur_matrix
```

[1]: https://data.cnra.ca.gov/dataset/human-uses-and-socioeconomic-dimensions-ca-north-coast-mpa-baseline-study-1992-2014
[2]: https://caseagrant.ucsd.edu/seafood-profiles/ 
[3]: https://nrm.dfg.ca.gov/
